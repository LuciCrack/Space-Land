<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Base 2D â€“ Builder (HTML + SVG + JS)</title>
<style>
  :root{ --cell:64px; --cols:12; --rows:7; --pad:16px; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Ubuntu; color:#e5e7eb; background:#0b1220; }
  .app{ display:flex; min-height:100vh; }
  aside{ width:300px; padding:16px; border-right:1px solid #1f2937; background:; }
  .title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .pill{ font-size:10px; background:#111827; border:1px solid #1f2937; padding:2px 8px; border-radius:999px; }
  .palette{ display:grid; gap:8px; }
  .tile{ display:flex; align-items:center; gap:10px; padding:10px; background:#111827; border:1px solid #1f2937; border-radius:14px; cursor:grab; user-select:none; }
  .tile img{ width:32px; height:32px; object-fit:contain; pointer-events:none; }
  .meta{ font-size:12px; color:#9ca3af; }
  .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:12px 0; }
  .btn{ padding:10px 12px; border-radius:12px; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; cursor:pointer; }
  .btn:hover{ background:#111827; }
  .hint{ font-size:12px; color:#9ca3af; margin-top:8px; }
  main{ position:relative; flex:1; }
  svg{ display:block; width:100%; height:90vh; touch-action:none; user-select:none; }
  .ghost{ opacity:.7; pointer-events:none; }
  .badge{ position:absolute; top:8px; right:12px; font-size:12px; background:#271111; border:1px solid #1f2937; padding:4px 8px; border-radius:999px; color:#9ca3af; }
  .node-selected image, .node-selected rect { outline: none; }
  .node-selected > rect { stroke:#60a5fa; stroke-width:2; fill:none; }
  .info-btn img { filter: brightness(1.5); }
  .info-btn:focus { outline: 2px solid #60a5fa; }
  #module-details-menu {
    position: absolute;
    top: 0;
    left: 300px; /* width of aside */
    width: 300px;
    height: 100vh;
    background: #111827;
    color: #e5e7eb;
    box-shadow: -2px 0 8px rgba(0,0,0,0.15);
    z-index: 50;
    transition: opacity 0.2s;
    opacity: 0;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    padding: 16px;
  }
  #module-details-menu.visible {
    opacity: 1;
    pointer-events: auto;
  }
</style>
</head>
<body>
<div style="width:100%; display:flex; justify-content:center; align-items:center; gap:32px; margin:32px 0 0 0;">
  <img src="{{ url_for('static', filename='icons/Book_Gray.png') }}" alt="Book" title="Book" style="width:40px; height:40px;">
  <img src="{{ url_for('static', filename='icons/Warning.png') }}" alt="Warning" title="Warning" style="width:40px; height:40px;">
  <img src="{{ url_for('static', filename='icons/Rocket.png') }}" alt="Rocket" title="Rocket" style="width:40px; height:40px;">
  <img src="{{ url_for('static', filename='icons/VR.png') }}" alt="VR" title="VR" style="width:40px; height:40px;">
  <img id="btn-3dview" src="{{ url_for('static', filename='icons/3d.png') }}" alt="3D" title="3D View" style="width:40px; height:40px; cursor:pointer;">
</div>
<div class="app">
  <aside>
    <div class="title">
      <h1 style="margin:0;font-size:18px;">Modules</h1>
      <span class="pill">drag</span>
    </div>
    <div class="palette" id="palette">
<div class="tile" data-key="hab" data-label="Habitat"
     data-src="{{ url_for('static', filename='modules/habitat.png') }}"
     data-description="Module for crew housing."
     data-energy-produced="0 MW"
     data-weight="25,000 kg"
     data-size="Large"
     data-purpose="Living Quarters">
  <img src="{{ url_for('static', filename='modules/habitat.png') }}"/>
  <div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Habitat</span>
      <button class="info-btn" title="Info" style="background:none;border:none;cursor:pointer;padding:0;">
        <img src="{{ url_for('static', filename='icons/Info.png') }}" alt="Info" style="width:18px;height:18px;">
      </button>
    </div>
    <div class="meta">hab</div>
  </div>
</div>

<div class="tile" data-key="solar" data-label="Solar"
     data-src="{{ url_for('static', filename='modules/solar.png') }}"
     data-description="Module for solar energy generation."
     data-energy-produced="5 MW"
     data-weight="10,000 kg"
     data-size="Medium"
     data-purpose="Energy Generation">
  <img src="{{ url_for('static', filename='modules/solar.png') }}"/>
  <div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Solar</span>
      <button class="info-btn" title="Info" style="background:none;border:none;cursor:pointer;padding:0;">
        <img src="{{ url_for('static', filename='icons/info.png') }}" alt="Info" style="width:18px;height:18px;">
      </button>
    </div>
    <div class="meta">solar</div>
  </div>
</div>

<div class="tile" data-key="lab" data-label="Laboratory"
     data-src="{{ url_for('static', filename='modules/lab.png') }}"
     data-description="Module for scientific research."
     data-energy-produced="1 MW"
     data-weight="15,000 kg"
     data-size="Medium"
     data-purpose="Research">
  <img src="{{ url_for('static', filename='modules/lab.png') }}"/>
  <div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Laboratory</span>
      <button class="info-btn" title="Info" style="background:none;border:none;cursor:pointer;padding:0;">
        <img src="{{ url_for('static', filename='icons/info.png') }}" alt="Info" style="width:18px;height:18px;">
      </button>
    </div>
    <div class="meta">lab</div>
  </div>
</div>

<div class="tile" data-key="store" data-label="Storage"
     data-src="{{ url_for('static', filename='modules/store.png') }}"
     data-description="Module for storing supplies."
     data-energy-produced="0 MW"
     data-weight="20,000 kg"
     data-size="Large"
     data-purpose="Storage">
  <img src="{{ url_for('static', filename='modules/store.png') }}"/>
  <div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Storage</span>
      <button class="info-btn" title="Info" style="background:none;border:none;cursor:pointer;padding:0;">
        <img src="{{ url_for('static', filename='icons/info.png') }}" alt="Info" style="width:18px;height:18px;">
      </button>
    </div>
    <div class="meta">store</div>
  </div>
</div>

<div class="tile" data-key="greenhouse" data-label="GreenHouse"
     data-src="{{ url_for('static', filename='modules/greenhouse.png') }}"
     data-description="Module for growing plants."
     data-energy-produced="2 MW"
     data-weight="18,000 kg"
     data-size="Medium"
     data-purpose="Agriculture">
  <img src="{{ url_for('static', filename='modules/greenhouse.png') }}"/>
  <div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>GreenHouse</span>
      <button class="info-btn" title="Info" style="background:none;border:none;cursor:pointer;padding:0;">
        <img src="{{ url_for('static', filename='icons/info.png') }}" alt="Info" style="width:18px;height:18px;">
      </button>
    </div>
    <div class="meta">greenhouse</div>
  </div>
</div>

    </div>
    <div class="actions">
      <button class="btn" id="clear">Clear</button>
      <button class="btn" id="export">Export</button>
      <label class="btn" style="text-align:center;cursor:pointer;">Import
        <input type="file" id="import" accept="application/json" style="display:none;" />
      </label>
      <button class="btn" id="save">Save</button>
      <button class="btn" id="load">Load</button>
    </div>
    <div class="hint">Drop onto free cells. Click to select; use arrow keys to move; Delete/Backspace to remove. Export/Import JSON.</div>
  </aside>
  <!-- Move sidebar here, after aside, before main -->
  <div id="module-details-menu">
    <button class="close-btn" id="close-details-btn" style="background:none;border:none;color:#e5e7eb;cursor:pointer;font-size:16px;">Close</button>
    <h2 id="module-name">Module Name</h2>
    <span class="detail-label">Description:</span>
    <span class="detail-value" id="module-description"></span><br>
    <span class="detail-label">Energy Produced:</span>
    <span class="detail-value" id="module-energy"></span><br>
    <span class="detail-label">Weight:</span>
    <span class="detail-value" id="module-weight"></span><br>
    <span class="detail-label">Size:</span>
    <span class="detail-value" id="module-size"></span><br>
    <span class="detail-label">Purpose:</span>
    <span class="detail-value" id="module-purpose"></span>
  </div>
  <main>
    <div class="badge" id="badge">0 Module</div>
    <svg id="stage" aria-label="board"></svg>
    <!-- Add 5 icons in the lower right corner -->
    <div style="
      position: absolute;
      right: 24px;
      bottom: 105px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 10;
      align-items: flex-end;
    ">
      <img src="{{ url_for('static', filename='icons/water.png') }}" alt="Water" title="Water" style="width:36px; height:36px;">
      <img src="{{ url_for('static', filename='icons/weight.png') }}" alt="Weight" title="Weight" style="width:36px; height:36px;">
      <img src="{{ url_for('static', filename='icons/electricity.png') }}" alt="Electricity" title="Electricity" style="width:36px; height:36px;">
      <img src="{{ url_for('static', filename='icons/oxygen.png') }}" alt="Oxygen" title="Oxygen" style="width:36px; height:36px;">
      <img src="{{ url_for('static', filename='icons/Eye.png') }}" alt="Other" title="Other" style="width:36px; height:36px;">
    </div>
  </main>
</div>

<!-- Replace your current modal video block with this one (no controls, autoplay) -->
<div id="vr-video-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:999; align-items:center; justify-content:center;">
  <video id="vr-video" width="1920" style="border-radius:12px; box-shadow:0 0 32px #000;" autoplay>
    <source src="{{ url_for('static', filename='video/vr_view.mp4') }}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <button id="close-vr-video" style="position:absolute; top:32px; right:48px; font-size:2rem; background:none; color:#fff; border:none; cursor:pointer;">&times;</button>
</div>

<script>
// =====================
// CONFIG & STATE
// =====================
const CELL = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell')) || 64;
const COLS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cols')) || 12;
const ROWS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--rows')) || 7;
const PAD  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pad'))  || 16;

const stage = document.getElementById('stage');
const palette = document.getElementById('palette');
const badge = document.getElementById('badge');

const W = COLS * CELL + PAD * 2;
const H = ROWS * CELL + PAD * 2;

/**
 * @typedef {Object} Node
 * @property {string} id
 * @property {string} type
 * @property {string} label
 * @property {string} src
 * @property {number} x
 * @property {number} y
 */
/** @type {Node[]} */
let nodes = [];
let selectedId = null;
let draggingId = null; // id of existing node when dragging
let ghost = null; // {type,label,src,x,y} when dragging from palette

// =====================
// HELPERS
// =====================
const uid = () => (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const inBounds = (col,row)=> col>=0 && col<COLS && row>=0 && row<ROWS;
const snapToCell = (clientX, clientY) => {
  const pt = screenToSvg(clientX, clientY);
  const x = clamp(Math.floor((pt.x - PAD) / CELL), 0, COLS-1);
  const y = clamp(Math.floor((pt.y - PAD) / CELL), 0, ROWS-1);
  return {col:x, row:y};
};
const occupied = (col,row, ignoreId=null) =>
  nodes.some(n => n.x===col && n.y===row && n.id!==ignoreId);

function screenToSvg(clientX, clientY){
  const p = stage.createSVGPoint();
  p.x = clientX; p.y = clientY;
  const m = stage.getScreenCTM().inverse();
  return p.matrixTransform(m);
}

function updateBadge(){ badge.textContent = `${nodes.length} Module${nodes.length===1?'':'s'}`; }

function setSelected(id){
  selectedId = id;
  renderNodes();
}

function addNode(type,label,src,col,row){
  if(!inBounds(col,row) || occupied(col,row)) return null;
  const n = { id:uid(), type,label,src, x:col, y:row };
  nodes.push(n);
  setSelected(n.id);
  renderNodes();
  updateBadge();
  return n;
}

function removeSelected(){
  if(!selectedId) return;
  nodes = nodes.filter(n=>n.id!==selectedId);
  selectedId = null;
  renderNodes();
  updateBadge();
}

// =====================
// SVG GRID
// =====================
function drawGrid(){
  stage.setAttribute('viewBox', `0 0 ${W} ${H}`);
  stage.innerHTML = '';

  // background color (behind image)
  const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
  bg.setAttribute('x', 0); bg.setAttribute('y', 0);
  bg.setAttribute('width', W); bg.setAttribute('height', H);
  bg.setAttribute('fill', '#0b1220');
  stage.appendChild(bg);

  // background image (on top of color)
  const bgImg = document.createElementNS('http://www.w3.org/2000/svg','image');
  bgImg.setAttributeNS('http://www.w3.org/1999/xlink','href', "{{ url_for('static', filename='img/surface.png') }}");
  bgImg.setAttribute('x', PAD);
  bgImg.setAttribute('y', PAD);
  bgImg.setAttribute('width', COLS*CELL);
  bgImg.setAttribute('height', ROWS*CELL);
  bgImg.setAttribute('preserveAspectRatio','none');
  stage.appendChild(bgImg);

  // panel
  const panel = document.createElementNS('http://www.w3.org/2000/svg','rect');
  panel.setAttribute('x', PAD); panel.setAttribute('y', PAD);
  panel.setAttribute('width', COLS*CELL); panel.setAttribute('height', ROWS*CELL);
  panel.setAttribute('fill', 'none');
  panel.setAttribute('stroke', '#1f2937');
  stage.appendChild(panel);

  // grid lines
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('stroke', '#1f2937');
  g.setAttribute('stroke-width', '1');
  for(let c=1;c<COLS;c++){
    const x = PAD + c*CELL + .5;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x); line.setAttribute('y1', PAD);
    line.setAttribute('x2', x); line.setAttribute('y2', PAD+ROWS*CELL);
    g.appendChild(line);
  }
  for(let r=1;r<ROWS;r++){
    const y = PAD + r*CELL + .5;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', PAD); line.setAttribute('y1', y);
    line.setAttribute('x2', PAD+COLS*CELL); line.setAttribute('y2', y);
    g.appendChild(line);
  }
  stage.appendChild(g);

  // nodes container
  const nLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
  nLayer.setAttribute('id','nodes-layer');
  stage.appendChild(nLayer);

  renderNodes();
}

function renderNodes(){
  let layer = document.getElementById('nodes-layer');
  if(!layer){ drawGrid(); layer = document.getElementById('nodes-layer'); }

  // clear
  layer.innerHTML = '';

  // Draw horizontal bridges first
  nodes.forEach(n1 => {
    nodes.forEach(n2 => {
      // Only horizontal bridges (left/right)
      if (n1.id !== n2.id && n1.y === n2.y && Math.abs(n1.x - n2.x) === 1) {
        // Always draw bridge from left to right
        const leftNode = n1.x < n2.x ? n1 : n2;
        const bx = PAD + leftNode.x * CELL + CELL / 2;
        const by = PAD + leftNode.y * CELL + CELL / 2 - 5;
        const bridge = document.createElementNS('http://www.w3.org/2000/svg','image');
        bridge.setAttributeNS('http://www.w3.org/1999/xlink','href', "{{ url_for('static', filename='Modules/Bridge_H.png') }}");
        bridge.setAttribute('x', bx);
        bridge.setAttribute('y', by);
        bridge.setAttribute('width', CELL);
        bridge.setAttribute('height', 32);
        bridge.setAttribute('preserveAspectRatio','xMidYMid meet');
        layer.appendChild(bridge);
      }
      // Vertical bridges (up/down)
      if (n1.id !== n2.id && n1.x === n2.x && Math.abs(n1.y - n2.y) === 1) {
        // Always draw bridge from top to bottom
        const topNode = n1.y < n2.y ? n1 : n2;
        const bx = PAD + topNode.x * CELL + CELL / 2 - 15;
        const by = PAD + topNode.y * CELL + CELL / 2;
        const bridgeV = document.createElementNS('http://www.w3.org/2000/svg','image');
        bridgeV.setAttributeNS('http://www.w3.org/1999/xlink','href', "{{ url_for('static', filename='Modules/Bridge_V.png') }}");
        bridgeV.setAttribute('x', bx);
        bridgeV.setAttribute('y', by);
        bridgeV.setAttribute('width', 32);
        bridgeV.setAttribute('height', CELL);
        bridgeV.setAttribute('preserveAspectRatio','xMidYMid meet');
        layer.appendChild(bridgeV);
      }
    });
  });

  // Draw nodes
  nodes.forEach(n=>{
    const pos = n._tmp ?? n; // use temporary position if exists (drag preview)
    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
    group.setAttribute('transform', `translate(${PAD + pos.x*CELL}, ${PAD + pos.y*CELL})`);
    group.setAttribute('data-id', n.id);
    group.classList.add('node');

    // hitbox for selection
    const sel = document.createElementNS('http://www.w3.org/2000/svg','rect');
    sel.setAttribute('x', 2); sel.setAttribute('y', 2);
    sel.setAttribute('width', CELL-4); sel.setAttribute('height', CELL-4);
    sel.setAttribute('fill', 'none');
    sel.setAttribute('stroke', 'none');
    group.appendChild(sel);

    const img = document.createElementNS('http://www.w3.org/2000/svg','image');
    img.setAttributeNS('http://www.w3.org/1999/xlink','href', n.src);
    img.setAttribute('x', 8); img.setAttribute('y', 8);
    img.setAttribute('width', CELL-16); img.setAttribute('height', CELL-16);
    img.setAttribute('preserveAspectRatio','xMidYMid meet');
    group.appendChild(img);

    if(n.id===selectedId){
      group.classList.add('node-selected');
      sel.setAttribute('stroke','#60a5fa');
      sel.setAttribute('stroke-width','2');
    }

    // events
    group.addEventListener('mousedown', (ev)=>{
      ev.preventDefault();
      setSelected(n.id);
      draggingId = n.id;
      window.addEventListener('mousemove', onDragExisting);
      window.addEventListener('mouseup', onDropExisting, {once:true});
    });

    layer.appendChild(group);
  });
}

// =====================
// DRAG from PALETTE (ghost)
// =====================
palette.querySelectorAll('.tile').forEach(tile=>{
  tile.addEventListener('mousedown', (ev)=>{
    // Only start drag if NOT clicking the info button
    if (ev.target.closest('.info-btn')) return;
    ev.preventDefault();
    const type = tile.dataset.key;
    const label = tile.dataset.label || type;
    const src = tile.dataset.src;
    startGhost(ev.clientX, ev.clientY, {type,label,src});
  });
});

// Info button event for showing module details sidebar
palette.querySelectorAll('.tile').forEach(tile=>{
  const infoBtn = tile.querySelector('.info-btn');
  if(infoBtn) {
    infoBtn.addEventListener('click', function(ev){
      ev.stopPropagation();
      ev.preventDefault();
      const sidebar = document.getElementById('module-details-menu');
      document.getElementById('module-name').textContent = tile.dataset.label || tile.dataset.key || '';
      document.getElementById('module-description').textContent = tile.dataset.description || '';
      document.getElementById('module-energy').textContent = tile.dataset.energyProduced || tile.dataset.energy_produced || '';
      document.getElementById('module-weight').textContent = tile.dataset.weight || '';
      document.getElementById('module-size').textContent = tile.dataset.size || '';
      document.getElementById('module-purpose').textContent = tile.dataset.purpose || '';
      sidebar.classList.add('visible');
    });
  }
});

// Close button for sidebar
document.getElementById('close-details-btn').addEventListener('click', function(){
  document.getElementById('module-details-menu').classList.remove('visible');
});

function startGhost(cx, cy, data){
  ghost = { ...data, x:0, y:0 };
  drawGhostAt(cx, cy);
  window.addEventListener('mousemove', onGhostMove);
  window.addEventListener('mouseup', onGhostDrop, {once:true});
}

function drawGhostAt(cx, cy){
  const {col,row} = snapToCell(cx, cy);
  ghost.x = col; ghost.y = row;

  // remove old
  let g = document.getElementById('ghost');
  if(g) g.remove();

  // new
  g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('id','ghost');
  g.classList.add('ghost');
  g.setAttribute('transform', `translate(${PAD + col*CELL}, ${PAD + row*CELL})`);

  const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  rect.setAttribute('x', 2); rect.setAttribute('y', 2);
  rect.setAttribute('width', CELL-4); rect.setAttribute('height', CELL-4);
  rect.setAttribute('fill', occupied(col,row) ? '#7f1d1d' : '#1f2937');
  rect.setAttribute('stroke', occupied(col,row) ? '#f87171' : '#9ca3af');
  rect.setAttribute('stroke-dasharray','6 6');
  g.appendChild(rect);

  const img = document.createElementNS('http://www.w3.org/2000/svg','image');
  img.setAttributeNS('http://www.w3.org/1999/xlink','href', ghost.src);
  img.setAttribute('x', 8); img.setAttribute('y', 8);
  img.setAttribute('width', CELL-16); img.setAttribute('height', CELL-16);
  img.setAttribute('preserveAspectRatio','xMidYMid meet');
  g.appendChild(img);

  stage.appendChild(g);
}

function onGhostMove(ev){
  drawGhostAt(ev.clientX, ev.clientY);
}

function onGhostDrop(ev){
  window.removeEventListener('mousemove', onGhostMove);
  const {col,row} = snapToCell(ev.clientX, ev.clientY);
  if(!occupied(col,row)){
    addNode(ghost.type, ghost.label, ghost.src, col, row);
  }
  const g = document.getElementById('ghost');
  if(g) g.remove();
  ghost = null;
}

// =====================
// DRAG of EXISTING NODE
// =====================
function onDragExisting(ev){
  const n = nodes.find(nn=>nn.id===draggingId);
  if(!n) return;
  const {col,row} = snapToCell(ev.clientX, ev.clientY);
  n._tmp = {x:col, y:row}; // preview
  renderNodes();
}

function onDropExisting(ev){
  window.removeEventListener('mousemove', onDragExisting);
  const n = nodes.find(nn=>nn.id===draggingId);
  if(!n){ draggingId=null; return; }
  const target = n._tmp || {x:n.x, y:n.y};
  delete n._tmp;
  const {x:col, y:row} = target;
  if(inBounds(col,row) && !occupied(col,row, n.id)){
    n.x = col; n.y = row;
  }
  draggingId = null;
  renderNodes();
}

// =====================
// INPUTS: selection, keyboard
// =====================
// If you click outside a node (background, grid, etc.), deselect
stage.addEventListener('mousedown', (ev)=>{
  const isNode = ev.target.closest && ev.target.closest('.node');
  if(!isNode) setSelected(null);
});

document.addEventListener('keydown', (ev)=>{
  if(!selectedId) return;
  const n = nodes.find(nn=>nn.id===selectedId);
  if(!n) return;

  const move = (dx,dy)=>{
    const nx = clamp(n.x+dx, 0, COLS-1);
    const ny = clamp(n.y+dy, 0, ROWS-1);
    if(!occupied(nx,ny,n.id)){ n.x = nx; n.y = ny; renderNodes(); }
  };

  switch(ev.key){
    case 'ArrowUp': ev.preventDefault(); move(0,-1); break;
    case 'ArrowDown': ev.preventDefault(); move(0,1); break;
    case 'ArrowLeft': ev.preventDefault(); move(-1,0); break;
    case 'ArrowRight': ev.preventDefault(); move(1,0); break;
    case 'Delete':
    case 'Backspace':
      ev.preventDefault(); removeSelected(); break;
  }
});

// =====================
// EXPORT / IMPORT / SAVE
// =====================
document.getElementById('export').addEventListener('click', ()=>{
  const data = JSON.stringify({cols:COLS, rows:ROWS, cell:CELL, nodes}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'layout.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('import').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const obj = JSON.parse(text);
    if(Array.isArray(obj.nodes)){
      nodes = obj.nodes.map(n=>({
        id: n.id || uid(),
        type: n.type, label: n.label, src: n.src,
        x: n.x|0, y: n.y|0
      })).filter(n=>inBounds(n.x,n.y));
      selectedId = null;
      renderNodes();
      updateBadge();
    }
  }catch(err){ alert('Invalid JSON'); }
  e.target.value = '';
});

document.getElementById('save').addEventListener('click', ()=>{
  localStorage.setItem('builder-layout', JSON.stringify(nodes));
  alert('Saved in this browser.');
});
document.getElementById('load').addEventListener('click', ()=>{
  const raw = localStorage.getItem('builder-layout');
  if(!raw) return alert('No previous save.');
  try{
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)){
      nodes = arr;
      selectedId = null;
      renderNodes();
      updateBadge();
    }
  }catch{ alert('Corrupted save.'); }
});
document.getElementById('clear').addEventListener('click', ()=>{
  if(confirm('Remove all modules from the board?')){
    nodes = []; selectedId=null; renderNodes(); updateBadge();
  }
});

// Play VR video when clicking the VR icon
document.querySelectorAll('img[alt="VR"]').forEach(img => {
  img.addEventListener('click', function() {
    document.getElementById('vr-video-modal').style.display = 'flex';
    const video = document.getElementById('vr-video');
    video.currentTime = 0;
    video.play();
  });
});

// Close modal
document.getElementById('close-vr-video').addEventListener('click', function() {
  document.getElementById('vr-video-modal').style.display = 'none';
  document.getElementById('vr-video').pause();
});

// Optional: close modal when clicking outside video
document.getElementById('vr-video-modal').addEventListener('click', function(e) {
  if(e.target === this){
    this.style.display = 'none';
    document.getElementById('vr-video').pause();
  }
});

// 3D button redirects to /view
document.getElementById('btn-3dview').addEventListener('click', function() {
  window.location.href = "/view";
});

// =====================
// INIT
// =====================
drawGrid();
updateBadge();
</script>
</body>
</html>